FROM golang:1.26-alpine AS builder

WORKDIR /app

COPY generated/go.mod generated/go.sum ./generated/
COPY agent/go.mod agent/go.sum ./agent/

WORKDIR /app/agent
RUN go mod download

WORKDIR /app
COPY generated ./generated
COPY agent ./agent

WORKDIR /app/agent
RUN CGO_ENABLED=0 GOOS=linux go build -o clarity-agent .

FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata docker-cli

WORKDIR /app
COPY --from=builder /app/agent/clarity-agent .

EXPOSE 8080

CMD ["./clarity-agent"]